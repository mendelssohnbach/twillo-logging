# ã‚¬ã‚¤ãƒ‰: Node.jsã§ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹æ–¹æ³•

[Blog](https://www.twilio.com/blog/a-guide-to-node-js-logging-jp)

```shell
$ npm init -y
$ npm install express
$ npm ls
â””â”€â”€ express@4.17.1
```

## consoleã«ã‚ˆã‚‹ãƒ­ã‚®ãƒ³ã‚°

[util.format(format[, ...args])](https://nodejs.org/dist/latest-v14.x/docs/api/util.html)


- %s: String
- %d: Number
- %i: parseInt
- %f: parseFloat
- %j: JSON
- %o: Object
- %O: Object
- %c: CSS
- %%: single percent

```js
// server.js
const express = require('express');
const PORT = process.env.PORT || 3000;
const app = express();

app.use((req, res, next) => {
  console.log('%s', req); // %o:ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“
  next();
});

app.get('/', (req, res) => {
  res.send('Hello World');
});

app.listen(PORT, () => {
  console.log('Server running on port %d', PORT);
});
```

```shell
$ node index.js
...
    [Symbol(kOutHeaders)]: [Object: null prototype] { 'x-powered-by': [Array] }
  },
  [Symbol(kCapture)]: false,
  [Symbol(RequestTimeout)]: undefined
}
```

```js
// server.js
app.use((req, res, next) => {
  console.log('%s', req); // %o:ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“
  next();
});
```

```shell
$ node index.js
Server running on port 3000
IncomingMessage {
  _readableState: [ReadableState],
  _events: [Object: null prototype],
  _eventsCount: 1,
  ...
  [Symbol(kCapture)]: false,
  [Symbol(RequestTimeout)]: undefined
}
```

## Pinoã‚’ä½¿ã£ãŸãƒ­ã‚®ãƒ³ã‚°

[pino](https://getpino.io/#/)

> ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒéå¸¸ã«ä½ã„`Node.js`ãƒ­ã‚¬ãƒ¼

[express-pino-logger](https://github.com/pinojs/express-pino-logger#readme)

> `pino`ã§ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹é«˜é€ŸãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€‚ã¡ãªã¿ã«ã€`express`ãªã—ã§ã‚‚å‹•ä½œã—ã¾ã™ã€‚

```shell
 $ npm i pino express-pino-logger
 $ npm ls
â”œâ”€â”€ express-pino-logger@6.0.0
â”œâ”€â”€ express@4.17.1
â””â”€â”€ pino@6.11.3
```

```js
// server.js
const express = require('express');
const pino = require('pino');
const expressPino = require('express-pino-logger');

// `logger`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
const logger = pino({ level: process.env.LOG_LEVEL || 'info' });
// `express-pino-logger`ã«å‰²å½“
const expressLogger = expressPino({ logger });

const PORT = process.env.PORT || 3000;
const app = express();

// æ–°ã—ã„ãƒ­ã‚¬ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½œæˆ
app.use(expressLogger);

app.get('/', (req, res) => {
  // `logger.debug`ã‚’ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã«è¿½åŠ 
  logger.debug('Calling res.send');
  res.send('Hello World');
});

app.listen(PORT, () => {
  logger.info('Server running on port %d', PORT);
});
```

```shell
$ node index.js
{"level":30,"time":1622273674142,"pid":15506,"hostname":"tiger","msg":"Server running on port 3000"}
...
```

`JSON`ãƒ‡ãƒ¼ã‚¿ãŒå‡ºåŠ›ã•ã‚ŒãŸã€‚

ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´

```shell
$ LOG_LEVEL=debug node index.js
{"level":30,"time":1622273823101,"pid":15810,"hostname":"tiger","msg":"Server running on port 3000"}
...
```

### transportsã‚’ä½¿ã†

`Pino`ã®æ¨™æº–å‡ºåŠ›å½¢å¼ã‚’æ§˜ã€…ã«å¤‰æ›ã€‚`pino-pretty`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šåˆ¤åˆ¥ã—ã‚„ã™ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ­ã‚°ã‚’ä½œæˆã€‚

[pino-pretty](https://github.com/pinojs/pino-pretty#readme)

> åŸºæœ¬çš„ãª`ndjson`ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’æä¾›ã—ã¾ã™ã€‚

`ndjson`: æ”¹è¡ŒåŒºåˆ‡ã‚Š`JSON`

```shell
$ npm i -D pino-pretty
$ npm ls
â”œâ”€â”€ express-pino-logger@6.0.0
â”œâ”€â”€ express@4.17.1
â”œâ”€â”€ pino-pretty@5.0.1
â””â”€â”€ pino@6.11.3
```

```shell
$ LOG_LEVEL=debug node index.js | npx pino-pretty
[1622274547823] INFO (16587 on tiger): Server running on port 3000
[1622274553038] DEBUG (16587 on tiger): Calling res.send
[1622274553074] INFO (16587 on tiger): request completed
    req: {
      "id": 1,
      "method": "GET",
      "url": "/",
      "headers": {
        "host": "localhost:3000",
        ...
      },
      "remoteAddress": "::1",
      "remotePort": 50382
    }
    res: {
      "statusCode": 304,
      "headers": {
        "x-powered-by": "Express",
        "etag": "W/\"b-Ck1VqNd45QIvq3AZd8XYQLvEhtA\""
      }
    }
    responseTime: 37
```

é‡è¦ãªæƒ…å ±ãŒè‰²åˆ†ã‘ã•ã‚ŒãŸã€‚

### pino-colada

`pino-colada`ã§éŠã¶

[pino-colada](https://github.com/lrlna/pino-colada#readme)

```shell
$ npm i -D pino-colada
$ npm ls
â”œâ”€â”€ express-pino-logger@6.0.0
â”œâ”€â”€ express@4.17.1
â”œâ”€â”€ pino-colada@2.1.0
â”œâ”€â”€ pino-pretty@5.0.1
â””â”€â”€ pino@6.11.3
$ LOG_LEVEL=debug node index.js | npx pino-colada
16:59:29 âœ¨ Server running on port 3000
16:59:33 ğŸ› Calling res.send
16:59:33 âœ¨ request completed GET 304 / 36ms
```

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ã‚°

- ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã‚ˆã†ã«æ§‹æˆã™ã‚‹

`express`ã®ä¾‹

```shell
DEBUG=express:* node index.js
  express:application set "x-powered-by" to true +0ms
  express:application set "etag" to 'weak' +1ms
  express:application set "etag fn" to [Function: generateETag] +1ms
  ...
  express:router:route get '/' +1ms
  express:router:layer new '/' +0ms
{"level":30,"time":1622275596910,"pid":17795,"hostname":"tiger","msg":"Server running on port 3000"}
```

[debug](https://github.com/visionmedia/debug#readme)

> `Node.js`ã‚³ã‚¢ã®ãƒ‡ãƒãƒƒã‚°æ‰‹æ³•ã‚’ãƒ¢ãƒ‡ãƒ«ã«ã—ãŸå°ã•ãª`JavaScript`ãƒ‡ãƒãƒƒã‚° ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€‚

æŒ‡å®šã—ãŸã€Œåå‰ç©ºé–“ã€ã®å†…éƒ¨ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚

```shell
$ npm i -D debug
$ npm ls
â”œâ”€â”€ debug@2.6.9
â”œâ”€â”€ express-pino-logger@6.0.0
â”œâ”€â”€ express@4.17.1
â”œâ”€â”€ pino-colada@2.1.0
â”œâ”€â”€ pino-pretty@5.0.1
â””â”€â”€ pino@6.11.3
```

```js
// server.js
...
const randomId = require('./random-id');
...
  const id = randomId.getRandomId();
  ...
```

```shell
$ DEBUG=mylib:randomid node index.js
  mylib:randomid Library loaded +0ms
{"level":30,"time":1622276522358,"pid":18720,"hostname":"tiger","msg":"Server running on port 3000"}
  mylib:randomid Computing random ID +5s
  mylib:randomid Random ID is dof0lvkdg7r +2ms
{"level":30,"time":1622276527145,"pid":18720,"hostname":"tiger","req":{"id":1,"method":"GET","url":"/","headers":{"host":"localhost:3000","connection":"keep-alive"
...
"responseTime":57,"msg":"request completed"}
```

ãƒ–ãƒ©ã‚¦ã‚¶å‡ºåŠ›: `Hello World [ahxxdq64729]`

`pinoãƒ­ã‚°`ã«è¨˜éŒ²ã™ã‚‹

```shell
$ npm i -D pino-debug
$ npm ls
â”œâ”€â”€ pino-debug@2.0.0
$ DEBUG=mylib:randomid node -r pino-debug index.js | npx pino-colada
18:18:46 ğŸ› mylib:randomid Library loaded
18:18:46 âœ¨ Server running on port 3000
18:18:49 ğŸ› mylib:randomid Computing random ID
18:18:49 ğŸ› mylib:randomid Random ID is rnfeyrg6due
18:18:49 âœ¨ request completed GET 200 / 12ms
```

`pino-debug`ã¯ã€`debug`ã‚’åˆã‚ã¦ä½¿ç”¨ã™ã‚‹å‰ã«åˆæœŸåŒ–ã™ã‚‹ã“ã¨ã€‚`-r`ã‚’ä½¿ã†ã®ãŒç°¡å˜

## CLIå‡ºåŠ›

[chalk](https://github.com/chalk/chalk#readme)

```shell
$ npm i chalk
$ npm ls
â”œâ”€â”€ chalk@4.1.1
```

```js
// cli.js
const chalk = require('chalk');
console.log('%s hi there', chalk.cyan('INFO'));
```

```shell
$ node cli.js
INFO hi there // `INFO`ã«è‰²ãŒä»˜ã„ãŸ
$ CI=tue node cli.js
INFO hi there // `INFO`ã«è‰²ãŒãªããªã£ãŸ
```


